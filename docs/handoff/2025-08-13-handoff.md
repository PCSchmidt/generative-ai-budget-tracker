# Handoff - 2025-08-13

Context
- Goal: Deploy FastAPI backend to Railway and switch frontend (Vercel) off mock.
- Failure: Railway build failed at `COPY requirements-light.txt .` because the file wasn’t in build context when Railway built from repo root.

What changed today
- Frontend
  - Deployed successfully on Vercel earlier; UI uses `.web.js` for auth; DevModeIndicator added; Expenses MVP behind ProtectedRoute.
  - ApiService honors `REACT_APP_API_BASE_URL`; added production mock gating via `REACT_APP_ALLOW_MOCK_PROD` (currently enabled until backend is live).
- Backend
  - Added `backend/requirements-light.txt` (minimal deps).
  - `backend/start.sh` runs Alembic, binds `uvicorn` to `${PORT:-8000}`.
  - `backend/app/main.py` supports CORS via `FRONTEND_ORIGINS` or `FRONTEND_ORIGIN_REGEX`.
  - Railway service `backend` created; env vars set: `SECRET_KEY` (strong), `DATABASE_URL` (internal Postgres), `ACCESS_TOKEN_EXPIRE_MINUTES=60`, `BCRYPT_ROUNDS=12`, `FRONTEND_ORIGIN_REGEX` to allow Vercel/Railway + localhost.
  - Fixed `.gitignore` to allowlist `backend/requirements-light.txt`.
  - Adjusted `backend/Dockerfile.railway` to `COPY backend/*` paths so a repo-root build context works.
  - Added project-level `railway.toml` to explicitly point to `backend/Dockerfile.railway`.

Why the build failed
- Railway used the repository root as the build context and “Detected Dockerfile,” so `COPY requirements-light.txt .` looked at `/requirements-light.txt` (root) which didn’t exist. We now:
  1) Unignored the file so it uploads with the build context.
  2) Updated Dockerfile to copy from `backend/requirements-light.txt`.
  3) Added root `railway.toml` to force using `backend/Dockerfile.railway`.

Next steps to resume
1) Redeploy backend on Railway
   - From repo root:
     - `railway up -s backend -d`
   - Or use the Railway UI “Redeploy” for the `backend` service.
   - Watch build logs; expect it to proceed past the COPY step.
2) Health check
   - After deploy, open: `https://<backend-subdomain>.up.railway.app/health`.
   - Should return `{ status: "healthy" | "degraded" ... }` and include Alembic revision.
3) Frontend switch
   - In Vercel project env, set `REACT_APP_API_BASE_URL` to the backend URL.
   - Set `REACT_APP_ALLOW_MOCK_PROD=false` and redeploy.
4) E2E smoke
   - Signup/Login, add expense, view dashboard, AI insights and advice.

Notes
- If Railway still shows “Detected Dockerfile,” confirm project is using the committed `railway.toml` at repo root and the service is linked to this repo.
- Postgres service exists and variables were used for `DATABASE_URL`. If connection fails, verify internal hostname: `postgres.railway.internal` and database name `railway`.
- CORS can be widened using `FRONTEND_ORIGINS` or simplified via `FRONTEND_ORIGIN_REGEX` (already set).

Commits
- fix(railway): unignore backend/requirements-light.txt; add daily progress log; prep backend service vars
- fix(railway): adjust Dockerfile paths to support repo-root build context (COPY backend/*)
- chore(railway): add project-level railway.toml to use backend/Dockerfile.railway (pending push if not committed)
